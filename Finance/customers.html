<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<meta charset="UTF-8">
<title>Golden Crest Finance - Customers</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

<style>
/* Reset & font */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Poppins', sans-serif;
}

html, body {
  height: 100%;
}

body {
  background: radial-gradient(circle at top left, #1e293b, #0f172a 60%);
  color: white;
  padding: 0;
  margin: 0;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
}

/* Header */
.header {
  width: 95%;
  max-width: 480px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 0;
  margin-top: 1rem;
}

.header h2 {
  color: #d4af37;
  font-size: 1.5rem;
}

.back {
  text-decoration: none;
  color: #d4af37;
  font-weight: 600;
  font-size: 0.9rem;
}

/* Customer card */
.card {
  width: 95%;
  max-width: 480px;
  background: rgba(255,255,255,0.05);
  backdrop-filter: blur(1rem);
  padding: 1rem;
  border-radius: 1rem;
  margin-bottom: 1rem;
  box-shadow: 0 1rem 2rem rgba(0,0,0,0.5);
  display: flex;
  flex-direction: column;
}

/* Customer details */
.customer-name {
  font-size: 1.2rem;
  font-weight: 700;
  color: #d4af37;
}

.details {
  margin-top: 0.5rem;
  font-size: 0.9rem;
  line-height: 1.6;
  color: #ccc;
}

/* Payment input */
.input-group {
  margin-top: 0.8rem;
  display: flex;
  gap: 0.5rem;
}

input {
  flex: 1;
  padding: 0.6rem;
  border-radius: 0.5rem;
  border: none;
  outline: none;
  font-size: 0.9rem;
  background: rgba(255,255,255,0.05);
  color: white;
}

/* Buttons */
.btn {
  padding: 0.5rem 0.8rem;
  border: none;
  border-radius: 0.5rem;
  cursor: pointer;
  font-weight: 600;
  font-size: 0.85rem;
  transition: transform 0.2s ease;
}

.btn:hover {
  transform: scale(1.05);
}

.pay-btn { background: #22c55e; color: white; }
.edit-btn { background: #3b82f6; color: white; }
.delete-btn { background: #ef4444; color: white; }
.download-btn { background: #d4af37; color: black; }

/* Actions container */
.actions {
  margin-top: 0.8rem;
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

/* Mobile adjustments */
@media(max-width:400px){
  .header {
    width: 98%;
    padding: 0.8rem 0;
  }

  .header h2 {
    font-size: 1.3rem;
  }

  .back {
    font-size: 0.85rem;
  }

  .card {
    width: 98%;
    padding: 0.8rem;
    border-radius: 0.8rem;
  }

  .customer-name {
    font-size: 1rem;
  }

  .details {
    font-size: 0.8rem;
  }

  input, .btn {
    font-size: 0.8rem;
    padding: 0.5rem;
  }

  .actions {
    gap: 0.4rem;
  }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#d4af37">

</head>
<body>

<div class="header">
  <h2>Customers</h2>
  <a href="./index.html" class="back">← Back</a>
</div>

<div id="list"></div>

<script>

let customers = JSON.parse(localStorage.getItem("customers")) || [];
let container = document.getElementById("list");

function save(){
  localStorage.setItem("customers", JSON.stringify(customers));
  location.reload();
}

customers.forEach((c,index)=>{

  // Ensure required fields exist
  if(!c.payments) c.payments = [];
  if(!c.startDate) c.startDate = new Date().toISOString();

  let totalPaid = c.payments.reduce((sum,p)=> sum + p.amount, 0);
  let balance = c.totalPayable - totalPaid;

  let totalDays = c.totalDays || 0;

  let start = new Date(c.startDate);
  let today = new Date();

  let diffTime = today - start;
  let daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  if(daysPassed < 0) daysPassed = 0;

  let daysLeft = totalDays - daysPassed;
  if(daysLeft < 0) daysLeft = 0;

  container.innerHTML += `
  <div class="card">

    <div class="customer-name">${c.name}</div>

    <div class="details">
      Phone: ${c.phone}<br>
      Start Date: ${start.toLocaleDateString()}<br>
      Total Loan: ₹${c.totalPayable}<br>
      Total Days: ${totalDays}<br>
      Days Passed: ${daysPassed}<br>
      Days Left: ${daysLeft}<br>
      Paid Amount: ₹${totalPaid}<br>
      Balance: ₹${balance.toFixed(2)}
    </div>

    <div class="input-group">
      <input type="number" id="pay${index}" placeholder="Enter payment amount">
      <button class="btn pay-btn" onclick="addPayment(${index})">Add</button>
    </div>

    <div class="actions">
      <button class="btn edit-btn" onclick="editCustomer(${index})">Edit</button>
      <button class="btn delete-btn" onclick="deleteCustomer(${index})">Delete</button>
      <button class="btn download-btn" onclick="downloadPDF(${index})">Receipt</button>
    </div>

  </div>
  `;
});

function addPayment(i){
  let amount = parseFloat(document.getElementById("pay"+i).value);

  if(!amount || amount <= 0){
    alert("Enter valid amount");
    return;
  }

  customers[i].payments.push({
    date: new Date().toLocaleString(),
    amount: amount
  });

  save();
}

function deleteCustomer(i){
  if(confirm("Delete this customer?")){
    customers.splice(i,1);
    save();
  }
}

function editCustomer(i){
  let newName = prompt("Edit Name:", customers[i].name);
  let newPhone = prompt("Edit Phone:", customers[i].phone);

  if(newName) customers[i].name = newName;
  if(newPhone) customers[i].phone = newPhone;

  save();
}

/* ===== PROFESSIONAL RECEIPT PDF ===== */

function downloadPDF(i){

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  let c = customers[i];

  let totalPaid = c.payments.reduce((sum,p)=> sum + p.amount, 0);
  let balance = c.totalPayable - totalPaid;

  let totalDays = c.totalDays || 0;
  let start = new Date(c.startDate);
  let today = new Date();
  let diffTime = today - start;
  let daysPassed = Math.floor(diffTime / (1000 * 60 * 60 * 24));
  if(daysPassed < 0) daysPassed = 0;

  let daysLeft = totalDays - daysPassed;
  if(daysLeft < 0) daysLeft = 0;

  doc.setFillColor(212,175,55);
  doc.rect(0,0,210,25,'F');

  doc.setFontSize(16);
  doc.setTextColor(0,0,0);
  doc.text("Golden Crest Finance", 60, 15);

  doc.setTextColor(0,0,0);
  doc.setFontSize(12);

  doc.text("Customer Receipt", 20, 40);

  doc.text("Name: " + c.name, 20, 55);
  doc.text("Phone: " + c.phone, 20, 65);
  doc.text("Start Date: " + start.toLocaleDateString(), 20, 75);
  doc.text("Total Loan: ₹" + c.totalPayable, 20, 85);
  doc.text("Total Days: " + totalDays, 20, 95);
  doc.text("Days Passed: " + daysPassed, 20, 105);
  doc.text("Days Left: " + daysLeft, 20, 115);
  doc.text("Total Paid: ₹" + totalPaid, 20, 125);
  doc.text("Balance: ₹" + balance.toFixed(2), 20, 135);

  doc.text("Signature: ____________________", 20, 270);

  doc.save(c.name + "_Receipt.pdf");
}


if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
